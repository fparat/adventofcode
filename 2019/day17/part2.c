#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include <assert.h>
#include "intcode.h"

#define MAX_ROWS 128
#define MAX_COLS 128


typedef struct {
    software_t soft;
    icword_t output;
    const char *input;
} droid_t;

#define TO_DROID(soft_ptr) ((droid_t *) (soft_ptr))

static error_t droid_set_output(software_t *soft, icword_t value)
{
    droid_t *droid = TO_DROID(soft);
    droid->output = value;
    return ERR_YIELD_OUTPUT;
}

static error_t droid_get_input(software_t *soft, icword_t *value)
{
    droid_t *droid = TO_DROID(soft);
    if(!droid->input) {
        return ERR_FAILURE; /* end of string */
    }
    *value = *(droid->input++);
    printf("%c", (char) *value);
    return ERR_SUCCESS;
}

static droid_t *droid_new(void)
{
    droid_t *droid = malloc(sizeof(droid_t));
    memset(droid, 0, sizeof(*droid));
    intcode_init(&droid->soft);
    droid->soft.set_output = droid_set_output;
    droid->soft.get_input = droid_get_input;

    return droid;
}

static void droid_delete(droid_t *droid)
{
    intcode_destroy(&droid->soft);
    free(droid);
}

static void droid_wake_up(droid_t *droid)
{
    assert(droid->soft.mem[0] == 1);
    droid->soft.mem[0] = 2;
}

static void droid_run(droid_t *droid)
{
    error_t err;

    while((err = intcode_run(&droid->soft)) != ERR_SUCCESS) {
        if(err != ERR_YIELD_OUTPUT) {
            PANIC("intcode error");
        }

        if(droid->output < 128) {
            printf("%c", (char) droid->output);
        } else {
            printf("Part 2: " FMT_W "\n", droid->output);
        }
    }
}

int main(int argc, char **argv)
{
    // Camera feed from part 1
    //
    // ..............................................#######................................
    // ..............................................#......................................
    // ..............................................#......................................
    // ..............................................#......................................
    // ..............................................#......................................
    // ..............................................#......................................
    // ..........................................#############..............................
    // ..........................................#...#.......#..............................
    // ..........................................#...#.......#.........###########..........
    // ..........................................#...#.......#.........#.........#..........
    // ..........................................#...#.......#.........#.........#..........
    // ..........................................#...#.......#.........#.........#..........
    // ..................................#############.......#.........#.........#..........
    // ..................................#.......#...........#.........#.........#..........
    // ..................................#.......#...........#.........#.........#..........
    // ..................................#.......#...........#.........#.........#..........
    // ................................###########...........#.........#.........#..........
    // ................................#.#...................#.........#.........#..........
    // ................................#.#...................###########.........##########^
    // ................................#.#..................................................
    // ................................#.#..................................................
    // ................................#.#..................................................
    // ................................#.#..................................................
    // ................................#.#..................................................
    // ......................#############..................................................
    // ......................#.........#....................................................
    // ......................#.........###########..........................................
    // ......................#...................#..........................................
    // ......................#...................#..........................................
    // ......................#...................#..........................................
    // ......................#...................#..........................................
    // ......................#...................#..........................................
    // ......................#...................#..........................................
    // ......................#...................#..........................................
    // ......................###########.........#..........................................
    // ................................#.........#..........................................
    // ..............................#############..........................................
    // ..............................#.#....................................................
    // ..............................#.#....................................................
    // ..............................#.#....................................................
    // ..............................#.#....................................................
    // ..............................#.#....................................................
    // ###########...................#.#....................................................
    // #.........#...................#.#....................................................
    // #.........#...........###########....................................................
    // #.........#...........#.......#......................................................
    // #.........#...........#.......#......................................................
    // #.........#...........#.......#......................................................
    // #############.....#############......................................................
    // ..........#.#.....#...#..............................................................
    // ..........#.#.....#...#..............................................................
    // ..........#.#.....#...#..............................................................
    // ..........#.#.....#...#..............................................................
    // ..........#.#.....#...#..............................................................
    // ..........#############..............................................................
    // ............#.....#..................................................................
    // ............#.....#..................................................................
    // ............#.....#..................................................................
    // ............#.....#..................................................................
    // ............#.....#..................................................................
    // ............#######..................................................................
    //
    // The path is
    // L,10,R,10,L,10,L,10,R,10,R,12,L,12,L,10,R,10,L,10,L,10,R,10,R,12,L,12,R,12,L,12,R,6,R,12,L,12,R,6,R,10,R,12,L,12,L,10,R,10,L,10,L,10,R,10,R,12,L,12,R,12,L,12,R,6
    //
    // R,6 being is rare/specific, we can find R,12,L,12,R,6
    //
    // Actually, if we look from the end we can find the repeating patterns easily.
    // Could be coded maybe, but meh we'll do it by hand.
    //
    // L,10,
    // R,10,
    // L,10,
    // L,10,
    //     R,10,
    //     R,12,
    //     L,12,
    // L,10,
    // R,10,
    // L,10,
    // L,10,
    //     R,10,
    //     R,12,
    //     L,12,
    //         R,12,
    //         L,12,
    //         R,6,
    //         R,12,
    //         L,12,
    //         R,6,
    //     R,10,
    //     R,12,
    //     L,12,
    // L,10,
    // R,10,
    // L,10,
    // L,10,
    //     R,10,
    //     R,12,
    //     L,12,
    //         R,12,
    //         L,12,
    //         R,6
    //
    // A: L,10,R,10,L,10,L,10
    // B: R,10,R,12,L,12
    // C: R,12,L,12,R,6
    // Main: A,B,A,B,C,C,B,A,B,C

#define FUNC_MAIN  "A,B,A,B,C,C,B,A,B,C\n"
#define FUNC_A     "L,10,R,10,L,10,L,10\n"
#define FUNC_B     "R,10,R,12,L,12\n"
#define FUNC_C     "R,12,L,12,R,6\n"
#define VIDEO_FEED "n\n"

#define PROMPTS_INPUT (FUNC_MAIN FUNC_A FUNC_B FUNC_C VIDEO_FEED)

    droid_t *droid = droid_new();

    if(argc >= 2) {
        if(intcode_read_from_file(&droid->soft, argv[1]) != ERR_SUCCESS) {
            PANIC("Error reading input");
        }
    } else {
        PANIC("Please give input file in argument 1");
    }

    droid->input = PROMPTS_INPUT;
    droid_wake_up(droid);

    droid_run(droid);

    droid_delete(droid);

    printf("done\n");
    return 0;
}
